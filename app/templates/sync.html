{% extends "base.html" %}

{% block content %}
<div class="card">
    <h2>Sync Control</h2>
    
    <div class="stats">
        <div class="stat-card">
            <h3>Auto Sync</h3>
            <p>
                {% if config.sync_enabled %}
                    <span class="status-badge status-success">Enabled</span>
                {% else %}
                    <span class="status-badge status-info">Disabled</span>
                {% endif %}
            </p>
        </div>
        <div class="stat-card">
            <h3>Interval</h3>
            <p>{{ config.sync_interval_minutes }} min</p>
        </div>
    </div>
    
    <div style="margin-top: 1rem;">
        <button class="btn" onclick="runNow()">‚ñ∂ Run Sync Now</button>
        <button class="btn btn-secondary" onclick="cancelRun()" style="margin-left: 0.5rem;">
            ‚èπ Cancel Running Sync
        </button>
        
        {% if config.sync_enabled %}
            <button class="btn btn-secondary" onclick="toggleSync(false)" style="margin-left: 0.5rem;">
                Disable Auto Sync
            </button>
        {% else %}
            <button class="btn btn-secondary" onclick="toggleSync(true)" style="margin-left: 0.5rem;">
                Enable Auto Sync
            </button>
        {% endif %}
    </div>
    
    <div id="sync-result" style="margin-top: 1rem;"></div>
</div>

<div class="card">
    <h2>Current Status</h2>
    <div id="current-status">
        <div class="loading">Loading status...</div>
    </div>
</div>

<div class="card">
    <h2>Recent Runs</h2>
    <div id="runs-list">
        {% if runs %}
            <table>
                <thead>
                    <tr>
                        <th>Started</th>
                        <th>Status</th>
                        <th>Assets</th>
                        <th>Uploaded</th>
                        <th>Skipped</th>
                        <th>Failed</th>
                        <th>Deleted</th>
                        <th>Duration</th>
                    </tr>
                </thead>
                <tbody>
                    {% for run in runs %}
                    <tr onclick="viewRunLogs({{ run.id }})" style="cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor = '#f3f4f6';" onmouseout="this.style.backgroundColor = '';">
                        <td>{{ run.started_at.strftime('%Y-%m-%d %H:%M:%S') if run.started_at else 'N/A' }}</td>
                        <td>
                            <span class="status-badge 
                                {% if run.status.value == 'OK' %}status-success
                                {% elif run.status.value == 'RUNNING' %}status-info
                                {% else %}status-error{% endif %}">
                                {{ run.status.value }}
                            </span>
                        </td>
                        <td>{{ run.total_assets }}</td>
                        <td>{{ run.uploaded }}</td>
                        <td>{{ run.skipped }}</td>
                        <td>{{ run.failed }}</td>
                        <td>{{ run.deleted }}</td>
                        <td>
                            {% if run.finished_at and run.started_at %}
                                {{ "%.1f"|format((run.finished_at - run.started_at).total_seconds()) }}s
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p style="color: #6b7280;">No sync runs yet.</p>
        {% endif %}
    </div>
</div>

<script>
async function loadStatus() {
    const statusDiv = document.getElementById('current-status');
    
    try {
        const response = await fetch('/api/sync/status');
        const data = await response.json();
        
        let html = '<div class="stats">';
        html += `
            <div class="stat-card">
                <h3>Total Items</h3>
                <p>${data.total_items}</p>
            </div>
            <div class="stat-card">
                <h3>Synced Items</h3>
                <p>${data.synced_items}</p>
            </div>
        `;
        
        if (data.last_run) {
            const statusClass = data.last_run.status === 'OK' ? 'status-success' : 
                               data.last_run.status === 'RUNNING' ? 'status-info' : 'status-error';
            html += `
                <div class="stat-card">
                    <h3>Last Run</h3>
                    <p><span class="status-badge ${statusClass}">${data.last_run.status}</span></p>
                </div>
                <div class="stat-card">
                    <h3>Last Stats</h3>
                    <p style="font-size: 1rem;">
                        ‚Üë ${data.last_run.uploaded} uploaded<br>
                        ‚Üí ${data.last_run.skipped} skipped<br>
                        ‚úó ${data.last_run.failed} failed<br>
                        üóë ${data.last_run.deleted} deleted
                    </p>
                </div>
            `;
        }
        
        html += '</div>';
        statusDiv.innerHTML = html;
        
    } catch (error) {
        statusDiv.innerHTML = `<div class="alert alert-error">Failed to load status: ${error.message}</div>`;
    }
}

async function runNow() {
    const resultDiv = document.getElementById('sync-result');
    resultDiv.innerHTML = '<div class="alert alert-info">Starting sync...</div>';
    
    try {
        const response = await fetch('/api/sync/run', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">‚úì Sync started! Run ID: ${data.run_id}</div>`;
            
            // Refresh status after a delay
            setTimeout(() => {
                loadStatus();
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-error">‚úó Failed to start sync</div>`;
        }
    } catch (error) {
        if (error.message.includes('409')) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Sync is already running</div>';
        } else {
            resultDiv.innerHTML = `<div class="alert alert-error">‚úó Error: ${error.message}</div>`;
        }
    }
}

async function cancelRun() {
    const resultDiv = document.getElementById('sync-result');
    resultDiv.innerHTML = '<div class="alert alert-info">Requesting cancellation...</div>';

    try {
        const response = await fetch('/api/sync/cancel', {
            method: 'POST'
        });

        const data = await response.json();
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-warning">Cancellation requested for run ${data.run_id}</div>`;
            // Refresh status after a short delay
            setTimeout(() => {
                loadStatus();
                window.location.reload();
            }, 2000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-error">‚úó Failed to request cancellation</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-error">‚úó Error: ${error.message}</div>`;
    }
}

async function toggleSync(enabled) {
    try {
        const response = await fetch('/api/config/sync', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                enabled: enabled
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Auto sync ${enabled ? 'enabled' : 'disabled'}!`);
            window.location.reload();
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// Load status on page load
loadStatus();

// Auto-refresh status every 10 seconds
setInterval(loadStatus, 10000);

function viewRunLogs(runId) {
    window.location.href = `/sync/logs/${runId}`;
}
</script>
{% endblock %}
